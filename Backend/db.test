import express from 'express'
import {phoneCheck, codeCheck} from './src/authorization/authController'
import cors from 'cors'
import * as dotenv from 'dotenv'
import { Pool } from "pg"

dotenv.config()

const app = express()
const PORT = 3000

app.use(cors({
    origin: ['http://localhost:5173'],
    credentials: true
}))

app.use(express.json())

// ========== –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –ë–î ==========
console.log('üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è:')
console.log('DB_USER:', process.env.DB_USER || '‚ùå –ù–ï –ù–ê–ô–î–ï–ù–û')
console.log('DB_HOST:', process.env.DB_HOST || '‚ùå –ù–ï –ù–ê–ô–î–ï–ù–û')
console.log('DB_NAME:', process.env.DB_NAME || '‚ùå –ù–ï –ù–ê–ô–î–ï–ù–û')
console.log('DB_PORT:', process.env.DB_PORT || '5432 (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)')
console.log('JWT_SECRET:', process.env.JWT_SECRET ? '‚úÖ –ï—Å—Ç—å' : '‚ùå –ù–ï–¢!')

const pool = new Pool({
    user: process.env.DB_USER,
    host: process.env.DB_HOST,
    database: process.env.DB_NAME,
    password: process.env.DB_PASSWORD,
    port: parseInt(process.env.DB_PORT || '5432', 10),
})

// ========== –¢–ï–°–¢–û–í–´–ï –ú–ê–†–®–†–£–¢–´ –î–õ–Ø –ë–î ==========

// 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
app.get('/test-db', async (req, res) => {
    console.log('üß™ –ó–∞–ø—Ä–æ—Å –Ω–∞ /test-db')
    try {
        const result = await pool.query('SELECT NOW() as current_time, version() as pg_version')
        res.json({
            success: true,
            message: '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL —Ä–∞–±–æ—Ç–∞–µ—Ç!',
            current_time: result.rows[0].current_time,
            postgres_version: result.rows[0].pg_version
        })
    } catch (error: any) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ë–î:', error.message)
        res.status(500).json({
            success: false,
            error: error.message
        })
    }
})

// 2. –°–û–ó–î–ê–ù–ò–ï –¢–ê–ë–õ–ò–¶–´ USERS –° –í–°–ï–ú–ò –ü–û–õ–Ø–ú–ò
app.get('/create-users-table', async (req, res) => {
    console.log('üõ† –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã users...')
    try {
        await pool.query(`
            CREATE TABLE IF NOT EXISTS users (
                id SERIAL PRIMARY KEY,
                phone_number VARCHAR(20) UNIQUE NOT NULL,
                created_at TIMESTAMP DEFAULT NOW(),
                last_login TIMESTAMP DEFAULT NOW(),
                role VARCHAR(50) DEFAULT 'user'
            )
        `)
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–æ–∑–¥–∞–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
        const structure = await pool.query(`
            SELECT column_name, data_type, is_nullable, column_default
            FROM information_schema.columns
            WHERE table_name = 'users'
            ORDER BY ordinal_position
        `)
        
        console.log('‚úÖ –¢–∞–±–ª–∏—Ü–∞ users —Å–æ–∑–¥–∞–Ω–∞/–ø—Ä–æ–≤–µ—Ä–µ–Ω–∞')
        res.json({
            success: true,
            message: '‚úÖ –¢–∞–±–ª–∏—Ü–∞ users —Å–æ–∑–¥–∞–Ω–∞ –∏–ª–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç',
            structure: structure.rows
        })
    } catch (error: any) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã:', error.message)
        res.status(500).json({
            success: false,
            error: error.message
        })
    }
})

// 3. –¢–ï–°–¢ findOrCreateUser –§–£–ù–ö–¶–ò–ò (–∏–º–∏—Ç–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã authController)
app.post('/test-find-or-create', async (req, res) => {
    console.log('üß™ –¢–µ—Å—Ç —Ñ—É–Ω–∫—Ü–∏–∏ findOrCreateUser...')
    try {
        const { phone_number } = req.body
        
        if (!phone_number) {
            return res.status(400).json({ error: '–£–∫–∞–∂–∏—Ç–µ phone_number' })
        }
        
        console.log('üìû –¢–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è:', phone_number)
        
        // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –í–ê–®–£ —Ñ—É–Ω–∫—Ü–∏—é findOrCreateUser
        const query = `
            INSERT INTO users (phone_number, last_login, role)
            VALUES ($1, NOW(), 'user')
            ON CONFLICT (phone_number)
            DO UPDATE SET last_login = NOW()
            RETURNING id, phone_number, created_at, last_login, role
        `
        const values = [phone_number]

        console.log('üöÄ –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ –ë–î...')
        const result = await pool.query(query, values)
        console.log('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞:', result.rows[0])
        
        res.json({
            success: true,
            message: '‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω/–æ–±–Ω–æ–≤–ª–µ–Ω',
            user: result.rows[0]
        })
    } catch (error: any) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –≤ test-find-or-create:')
        console.error('–°–æ–æ–±—â–µ–Ω–∏–µ:', error.message)
        console.error('–ö–æ–¥ –æ—à–∏–±–∫–∏:', error.code)
        console.error('–î–µ—Ç–∞–ª–∏:', error.detail)
        
        res.status(500).json({
            success: false,
            error: error.message,
            code: error.code,
            detail: error.detail
        })
    }
})

// 4. –ü–û–°–ú–û–¢–†–ï–¢–¨ –í–°–ï–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô
app.get('/all-users', async (req, res) => {
    console.log('üë• –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...')
    try {
        const result = await pool.query(`
            SELECT id, phone_number, 
                   created_at, 
                   last_login,
                   role,
                   EXTRACT(EPOCH FROM (NOW() - created_at)) as seconds_since_creation
            FROM users 
            ORDER BY created_at DESC
        `)
        
        res.json({
            success: true,
            count: result.rowCount,
            users: result.rows
        })
    } catch (error: any) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error.message)
        res.status(500).json({
            success: false,
            error: error.message
        })
    }
})

// 5. –û–ß–ò–°–¢–ò–¢–¨ –¢–ê–ë–õ–ò–¶–£ (–¥–ª—è —Ç–µ—Å—Ç–æ–≤)
app.delete('/clear-users', async (req, res) => {
    console.log('üßπ –û—á–∏—Å—Ç–∫–∞ —Ç–∞–±–ª–∏—Ü—ã users...')
    try {
        const result = await pool.query('DELETE FROM users RETURNING *')
        res.json({
            success: true,
            message: `‚úÖ –£–¥–∞–ª–µ–Ω–æ ${result.rowCount} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`,
            deleted_users: result.rows
        })
    } catch (error: any) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Ç–∞–±–ª–∏—Ü—ã:', error.message)
        res.status(500).json({
            success: false,
            error: error.message
        })
    }
})

// 6. –ì–õ–ê–í–ù–ê–Ø –°–¢–†–ê–ù–ò–¶–ê –° –°–°–´–õ–ö–ê–ú–ò
app.get('/', (req, res) => {
    res.send(`
        <html>
        <head>
            <title>–¢–µ—Å—Ç–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä –ë–î</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
                .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
                .section { margin: 25px 0; }
                .btn { 
                    display: inline-block; 
                    padding: 10px 15px; 
                    margin: 5px; 
                    background: #3498db; 
                    color: white; 
                    text-decoration: none; 
                    border-radius: 5px; 
                    border: none;
                    cursor: pointer;
                    font-size: 14px;
                }
                .btn:hover { background: #2980b9; }
                .btn-danger { background: #e74c3c; }
                .btn-danger:hover { background: #c0392b; }
                .btn-success { background: #2ecc71; }
                .btn-success:hover { background: #27ae60; }
                .test-form { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0; }
                input { padding: 8px; margin: 5px; width: 200px; }
                .api-test { margin-top: 20px; }
                pre { background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 5px; overflow-x: auto; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üõ† –¢–µ—Å—Ç–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä –ë–î</h1>
                <p>–ü–æ—Ä—Ç: ${PORT}</p>
                
                <div class="section">
                    <h2>üìä –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ë–î:</h2>
                    <a href="http://localhost:3000/test-db" class="btn" target="_blank">‚úÖ –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</a>
                    <a href="http://localhost:3000/create-users-table" class="btn" target="_blank">üõ† –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É</a>
                    <a href="http://localhost:3000/all-users" class="btn" target="_blank">üë• –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
                    <a href="http://localhost:3000/clear-users" class="btn btn-danger" target="_blank" onclick="return confirm('–¢–æ—á–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É?')">üßπ –û—á–∏—Å—Ç–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É</a>
                </div>
                
                <div class="section">
                    <h2>üß™ –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</h2>
                    <div class="test-form">
                        <input type="text" id="phoneInput" placeholder="79991234567" value="79991234567">
                        <button class="btn btn-success" onclick="createUser()">–°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
                        <div id="result" style="margin-top: 10px;"></div>
                    </div>
                </div>
                
                <div class="section api-test">
                    <h2>üì° API –º–∞—Ä—à—Ä—É—Ç—ã (POST):</h2>
                    <pre>POST /phoneCheck
Content-Type: application/json
{ "phone": "79991234567" }

POST /codeCheck  
Content-Type: application/json
{ 
  "code": "1234", 
  "uuid": "test-uuid", 
  "phone_number": "79991234567" 
}</pre>
                </div>
            </div>
            
            <script>
                async function createUser() {
                    const phone = document.getElementById('phoneInput').value;
                    const resultDiv = document.getElementById('result');
                    
                    if (!phone) {
                        resultDiv.innerHTML = '<span style="color: red;">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</span>';
                        return;
                    }
                    
                    resultDiv.innerHTML = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...';
                    
                    try {
                        const response = await fetch('/test-find-or-create', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ phone_number: phone })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            resultDiv.innerHTML = \`
                                <span style="color: green;">‚úÖ –£—Å–ø–µ—à–Ω–æ!</span><br>
                                ID: \${data.user.id}<br>
                                –¢–µ–ª–µ—Ñ–æ–Ω: \${data.user.phone_number}<br>
                                –°–æ–∑–¥–∞–Ω: \${new Date(data.user.created_at).toLocaleString()}<br>
                                –†–æ–ª—å: \${data.user.role}
                            \`;
                        } else {
                            resultDiv.innerHTML = \`<span style="color: red;">‚ùå –û—à–∏–±–∫–∞: \${data.error}</span>\`;
                        }
                    } catch (error) {
                        resultDiv.innerHTML = \`<span style="color: red;">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: \${error.message}</span>\`;
                    }
                }
            </script>
        </body>
        </html>
    `)
})

// ========== –û–°–ù–û–í–ù–´–ï –ú–ê–†–®–†–£–¢–´ API ==========
app.post('/phoneCheck', phoneCheck)
app.post('/codeCheck', codeCheck)

// ========== –ó–ê–ü–£–°–ö –°–ï–†–í–ï–†–ê ==========
app.listen(PORT, () => {
    console.log('\n' + '='.repeat(60))
    console.log(`üöÄ –°–ï–†–í–ï–† –ó–ê–ü–£–©–ï–ù –ù–ê –ü–û–†–¢–£ ${PORT}`)
    console.log('='.repeat(60))
    console.log('\nüì° –û–¢–ö–†–û–ô–¢–ï –í –ë–†–ê–£–ó–ï–†–ï:')
    console.log(`üëâ http://localhost:${PORT}`)
    console.log('\nüß™ –¢–ï–°–¢–û–í–´–ï –ú–ê–†–®–†–£–¢–´ –ë–î:')
    console.log(`   ‚Ä¢ http://localhost:${PORT}/test-db`)
    console.log(`   ‚Ä¢ http://localhost:${PORT}/create-users-table`)
    console.log(`   ‚Ä¢ http://localhost:${PORT}/all-users`)
    console.log(`   ‚Ä¢ http://localhost:${PORT}/clear-users`)
    console.log('\nüì± API –ú–ê–†–®–†–£–¢–´:')
    console.log(`   ‚Ä¢ POST /phoneCheck`)
    console.log(`   ‚Ä¢ POST /codeCheck`)
    console.log(`   ‚Ä¢ POST /test-find-or-create`)
    console.log('\n' + '='.repeat(60))
})